# products/forms.py
from django import forms
from .models import Tapshiriq, QoshmaFayl, Qanunvericilik, Ishchi, Nezaret, NezaretQoshmaFayl
from .models import Struktur, StrukturQoshmaFayl
from .models import StrukturShexs


class TaskForm(forms.ModelForm):
    class Meta:
        model = Tapshiriq
        fields = [
            'qeydiyyat_nomresi', 'mezmun', 'qeyd', 'icrachi',
            'son_icra_tarixi', 'status', 'nezaret_tipi', 'esas_fayl'
        ]
        widgets = {
            'son_icra_tarixi': forms.DateInput(attrs={'class': 'form-control', 'type': 'date'})
        }

    def __init__(self, *args, **kwargs):
        self.user = kwargs.pop('user', None)
        super().__init__(*args, **kwargs)

        for field in self.fields.values():
            field.widget.attrs.setdefault('class', 'form-control')

        if self.user and not self.user.is_superuser:
            try:
                ishchi = Ishchi.objects.get(user=self.user)
                if ishchi.istifadechi_tipi == "Əməkdaş":
                    self.fields['icrachi'].widget = forms.HiddenInput()
                    self.fields['icrachi'].required = False
                elif ishchi.istifadechi_tipi in ("Rəis", "Admin", "Struktur Qurum"):
                    self.fields['icrachi'].queryset = Ishchi.objects.filter(
                        istifadechi_tipi="Əməkdaş"
                    )
            except Ishchi.DoesNotExist:
                for field in self.fields.values():
                    field.disabled = True

    def clean(self):
        cleaned_data = super().clean()
        icrachi = cleaned_data.get('icrachi')
        if not icrachi and self.user:
            try:
                ishchi = Ishchi.objects.get(user=self.user)
                if ishchi.istifadechi_tipi == "Əməkdaş":
                    cleaned_data['icrachi'] = ishchi
            except Ishchi.DoesNotExist:
                pass
        return cleaned_data


class QoshmaFaylForm(forms.ModelForm):
    class Meta:
        model = QoshmaFayl
        fields = ['fayl', 'tesvir']


class QanunvericilikForm(forms.ModelForm):
    class Meta:
        model = Qanunvericilik
        fields = ['ad', 'metn', 'audio_fayl', 'link', 'kateqoriya']

# YENİ ƏLAVƏ OLUNAN FORMLAR
class NezaretForm(forms.ModelForm):
    class Meta:
        model = Nezaret
        # "fields" siyahısına 'qeyd' əlavə edildi
        fields = ['mezmun', 'qeyd', 'icrachi', 'qeydiyyat_nomresi', 'daxil_olma_tarixi', 'say', 'esas_fayl']
        widgets = {
            'daxil_olma_tarixi': forms.DateInput(attrs={'class': 'form-control', 'type': 'date'})
        }

    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        for field in self.fields.values():
            field.widget.attrs.setdefault('class', 'form-control')
        self.fields['icrachi'].queryset = Ishchi.objects.filter(
            istifadechi_tipi__in=['Əməkdaş', 'Rəis']
        )

class NezaretQoshmaFaylForm(forms.ModelForm):
    class Meta:
        model = NezaretQoshmaFayl
        fields = ['fayl', 'tesvir']

class StrukturForm(forms.ModelForm):
    class Meta:
        model = Struktur
        # 'icrachi' sahəsi buradan silindi
        fields = ['mezmun', 'qeyd', 'qeydiyyat_nomresi', 'daxil_olma_tarixi', 'say', 'esas_fayl']
        widgets = {
            'daxil_olma_tarixi': forms.DateInput(attrs={'class': 'form-control', 'type': 'date'})
        }

    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        for field in self.fields.values():
            field.widget.attrs.setdefault('class', 'form-control')

class StrukturQoshmaFaylForm(forms.ModelForm):
    class Meta:
        model = StrukturQoshmaFayl
        fields = ['fayl', 'tesvir']


class StrukturShexsForm(forms.ModelForm):
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        # Bütün sahələri qeyri-məcburi edirik
        for field in self.fields.values():
            field.required = False

    class Meta:
        model = StrukturShexs
        fields = ['saa', 'tevellud', 'struktur_qurum', 'status', 'qeyd']
        widgets = {
            'saa': forms.TextInput(attrs={'class': 'form-control form-control-sm'}),
            'tevellud': forms.TextInput(attrs={'class': 'form-control form-control-sm'}),
            'struktur_qurum': forms.TextInput(attrs={'class': 'form-control form-control-sm'}),
            'status': forms.TextInput(attrs={'class': 'form-control form-control-sm'}),
            'qeyd': forms.Textarea(attrs={'class': 'form-control form-control-sm', 'rows': 1}),
        }
