{% extends "base.html" %}
{% load static %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="fw-bold mb-0">Tapşırıqlar</h2>

  <form method="get" class="d-flex" role="search" aria-label="Axtar tapşırıqlar">
    <div class="input-group">
      <input type="text" name="q" class="form-control" placeholder="Məzmun və ya icraçı adı ilə axtar..." value="{{ search_query|default:'' }}">
      <button class="btn btn-outline-secondary" type="submit"><i class="bi bi-search"></i></button>
    </div>
  </form>
</div>

{% if user.is_authenticated %}
  <div class="mb-3">
    <a href="{% url 'task-create' %}" class="btn btn-success">
      <i class="bi bi-plus-lg"></i> Yeni tapşırıq yarat
    </a>
  </div>
{% endif %}


<div class="row mb-3 gx-2">
  <div class="col-4">
    <a href="{% url 'task-list' %}?status={{ 'İcradadır'|urlencode }}" class="btn {% if current_status == 'İcradadır' %}btn-primary{% else %}btn-outline-secondary{% endif %} w-100">İcradadır</a>
  </div>
  <div class="col-4">
    <a href="{% url 'task-list' %}?status={{ 'İcra edildi'|urlencode }}" class="btn {% if current_status == 'İcra edildi' %}btn-primary{% else %}btn-outline-secondary{% endif %} w-100">İcra edildi</a>
  </div>
  <div class="col-4">
    <a href="{% url 'task-list' %}?status={{ 'İcra edilmədi'|urlencode }}" class="btn {% if current_status == 'İcra edilmədi' %}btn-primary{% else %}btn-outline-secondary{% endif %} w-100">İcra edilmədi</a>
  </div>
</div>

<div class="d-flex justify-content-end mb-2">
  <a href="{% url 'task-list' %}" class="btn btn-sm btn-link">Bütün tapşırıqlar</a>
</div>

<div class="row g-3">
  {% for task in tasks %}
    <div class="col-12">
      <div class="card task-card border-start-4 status-{{ task.status|cut:" "|lower }} {% if task.is_expired %}task-expired{% endif %}">
        <div class="card-body">

<div class="d-flex align-items-start justify-content-between">

  <!-- Sol tərəf -->
  <div class="me-3 flex-grow-1">
    <h5 class="task-title mb-3">
      <a href="{% url 'task-detail' task.pk %}" class="text-decoration-none">{{ task.mezmun }}</a>
    </h5>

    {% if task.icrachi %}
      <div class="task-info-badge task-badge-primary">
        👤 {{ task.icrachi.ad }} {{ task.icrachi.soyad }}
      </div>
    {% else %}
      <div class="task-info-badge task-badge-secondary">—</div>
    {% endif %}

    <div class="task-info-badge task-badge-info">
      🆔 Qeydiyyat № | {{ task.qeydiyyat_nomresi }}
    </div>

    <div class="task-info-badge 
                {% if task.is_expired %}task-badge-danger
                {% elif task.is_warning %}task-badge-warning
                {% else %}task-badge-success{% endif %}">
      📅 Son icra tarixi | {{ task.son_icra_tarixi|date:"d.m.Y" }}
    </div>
  </div>

  <!-- Sağ tərəf: badges + action düymələri -->
  <div class="d-flex flex-column text-end ms-auto" style="min-width: 200px;">
    <div>
      {% if task.is_expired %}
        <div class="mb-1"><span class="badge bg-danger">⏰ Müddəti bitmiş</span></div>
      {% elif task.is_warning %}
        <div class="mb-1"><span class="badge bg-warning text-dark">⚠ Son icra tarixi yaxınlaşır</span></div>
      {% endif %}
          <div class="mb-1">
      {% if task.nezaret_tipi == 'Nəzarətlə' %}
        <span class="badge bg-primary">📋 Nəzarətlə</span>
      {% endif %}
    </div>
      <div class="mb-2">
        <span class="status-badge 
          {% if task.status == 'İcradadır' %}status-icradadir
          {% elif task.status == 'İcra edildi' %}status-icraedildi
          {% elif task.status == 'İcra edilmədi' %}status-icraedilmedi
          {% else %}status-unknown{% endif %}">
          {{ task.status }}
        </span>
      </div>
    </div>

    <!-- Action buttons aşağıda -->
    <div class="card-actions mt-5">
      {% if user.is_authenticated %}
        {% if user.is_superuser %}
          <a href="{% url 'task-update' task.pk %}" class="btn btn-sm btn-outline-secondary" title="Redaktə et">
            <i class="bi bi-pencil"></i>
          </a>
          <a href="{% url 'task-delete' task.pk %}" class="btn btn-sm btn-outline-danger" title="Sil">
            <i class="bi bi-trash"></i>
          </a>
        {% else %}
          {% if task.icrachi and task.icrachi.user == user %}
            <a href="{% url 'task-update' task.pk %}" class="btn btn-sm btn-outline-secondary" title="Redaktə et">
              <i class="bi bi-pencil"></i>
            </a>
          {% endif %}
        {% endif %}
      {% endif %}
    </div>
  </div>

</div>

        </div>
      </div>
    </div>
  {% empty %}
    <div class="col-12">
      <div class="card">
        <div class="card-body text-center text-muted">Heç bir tapşırıq tapılmadı.</div>
      </div>
    </div>
  {% endfor %}
</div>

<!-- pagination -->
{% if is_paginated %}
  <nav aria-label="Səhifələmə" class="mt-3">
    <ul class="pagination justify-content-center">
      {% if page_obj.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if current_status %}&status={{ current_status|urlencode }}{% endif %}{% if search_query %}&q={{ search_query|urlencode }}{% endif %}">«</a>
        </li>
      {% endif %}
      <li class="page-item disabled"><span class="page-link">Səhifə {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span></li>
      {% if page_obj.has_next %}
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if current_status %}&status={{ current_status|urlencode }}{% endif %}{% if search_query %}&q={{ search_query|urlencode }}{% endif %}">»</a>
        </li>
      {% endif %}
    </ul>
  </nav>
{% endif %}

{% endblock %}
